# LifeLog仕様書

## 更新履歴
- 2024/12/01: 0.01公開
- 2024/12/08: モデル構造の改善とテスト仕様の追加
- 2024/12/09: データベース構造とマイグレーション仕様の追加
- 2024/12/10: 開発環境をcondaベースに変更

## 目次
1. [ユーザー管理機能](#1-ユーザー管理機能)
2. [日記管理機能](#2-日記管理機能)
3. [画面仕様](#3-画面仕様)
4. [データベース設計](#4-データベース設計)
5. [モデル構造](#5-モデル構造)
6. [セキュリティ仕様](#6-セキュリティ仕様)
7. [テスト仕様](#7-テスト仕様)
8. [注意事項](#8-注意事項)

## 1. ユーザー管理機能

### 1.1 ユーザー登録
- ユーザーID：4-20文字の半角英数字
- 名前（表示名）：3-20文字（文字種自由）
- パスワード：8-20文字（大文字・小文字・数字を各1文字以上含む）

### 1.2 ログイン機能
- ユーザーIDとパスワードによる認証
- 3回連続ログイン失敗でアカウントロック
- ロック解除は管理者のみ可能
- 退会済みユーザーはログイン不可（「ユーザーIDまたはパスワードが正しくありません」と表示）
 
### 1.3 退会機能
- パスワード確認による本人確認
- 退会後のアカウントは以下の制限が適用：
  - ログイン不可
  - 投稿した日記は管理者のみ閲覧可能
- 管理者アカウントは退会不可
- 退会処理は取り消し不可

### 1.4 ユーザー権限
1. 管理者（admin）
   - 全ユーザーの日記の閲覧・編集・削除（退会済みユーザーの日記を含む）
   - ユーザー管理（ロック解除、管理者権限の付与/削除）
   - 退会済みユーザーの日記の管理
   - 自身の設定変更（退会不可）

2. 一般ユーザー
   - アクティブなユーザーの日記の閲覧
   - 自身の日記の投稿・編集・削除
   - 自身の設定変更（退会可能）

3. 未ログインユーザー
   - アクティブなユーザーの日記の閲覧のみ

## 2. 日記管理機能

### 2.1 日記投稿
- タイトル（必須）
- 本文（必須）
- メモ（任意、天気・気分・体調など）
- 作成日時の自動記録
- 更新日時の自動記録（編集時）

### 2.2 日記表示
- 新しい順に表示
- 投稿者名とユーザーIDを表示
- 作成日時と最終更新日時を表示
- 編集・削除ボタンは権限のあるユーザーにのみ表示
- 退会済みユーザーの日記は管理者のみ閲覧可能

### 2.3 ユーザー設定機能

#### 2.3.1 設定可能項目
- 表示名の変更
- パスワードの変更（現在のパスワード確認あり）
- アカウント退会（パスワード確認あり）

### 2.4 管理者機能

#### 2.4.1 ユーザー管理
- ユーザー一覧の表示
  - アクティブユーザー
  - 退会済みユーザー（半透明表示）
- アカウントのロック状態の確認と解除
- 管理者権限の付与/削除（アクティブユーザーのみ）
- ログイン試行履歴の確認
- 退会済みユーザーの日記管理

## 3. 画面仕様

### 3.1 共通ヘッダー
未ログイン時：
- ホーム
- ログイン
- 新規登録

ログイン時：
- ホーム
- ユーザー設定
- ユーザー管理（管理者のみ）
- ログアウト
- ユーザー名表示
- 管理者バッジ（管理者のみ）

### 3.2 各画面

#### 3.2.1 ホーム画面（/）
- 日記一覧表示
- 投稿フォーム（ログイン時のみ）
  - タイトル入力
  - 本文入力
  - メモ入力（天気、気分、体調など）
- ページネーションなし

#### 3.2.2 ログイン画面（/login）
- ユーザーID入力
- パスワード入力
- ログイン試行回数表示
- エラーメッセージ表示

#### 3.2.3 ユーザー登録画面（/register）
- ユーザーID入力（バリデーション付き）
- 名前入力（バリデーション付き）
- パスワード入力（バリデーション付き）
- 入力規則の表示
- エラーメッセージ表示

#### 3.2.4 ユーザー設定画面（/settings）
- 表示名変更
- パスワード変更
- 現在の設定表示
- アカウント退会セクション
  - 退会ボタン
  - 確認モーダル
  - パスワード確認

#### 3.2.5 管理者画面（/admin）
- ユーザー一覧
  - アクティブ/退会済み状態表示
  - ロック状態表示
  - ログイン試行履歴
  - 管理者権限操作ボタン（アクティブユーザーのみ）
  - ロック解除ボタン

## 4. データベース設計

### 4.1 usersテーブル
```sql
CREATE TABLE users (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    userid TEXT NOT NULL UNIQUE,
    name TEXT NOT NULL,
    password TEXT NOT NULL,
    is_admin BOOLEAN NOT NULL DEFAULT 0,
    is_locked BOOLEAN NOT NULL DEFAULT 0,
    is_visible BOOLEAN NOT NULL DEFAULT 1,
    login_attempts INTEGER NOT NULL DEFAULT 0,
    last_login_attempt DATETIME,
    created_at DATETIME NOT NULL
);
```

### 4.2 entriesテーブル
```sql
CREATE TABLE entries (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id INTEGER NOT NULL,
    title TEXT NOT NULL,
    content TEXT NOT NULL,
    notes TEXT NOT NULL DEFAULT '',
    created_at DATETIME NOT NULL,
    updated_at DATETIME,
    FOREIGN KEY (user_id) REFERENCES users (id) ON DELETE CASCADE
);
```

### 4.3 diary_itemsテーブル
```sql
CREATE TABLE diary_items (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    entry_id INTEGER NOT NULL,
    item_name TEXT NOT NULL,
    item_content TEXT NOT NULL,
    created_at DATETIME NOT NULL,
    FOREIGN KEY (entry_id) REFERENCES entries (id) ON DELETE CASCADE
);
```

### 4.4 マイグレーション管理
- Alembicを使用したマイグレーション管理
- マイグレーションファイルは`migrations/versions/`に保存
- マイグレーション設定は`alembic.ini`で管理

## 5. モデル構造

### 5.1 基本構造
- Base: すべてのモデルの基底クラス
  - SQLAlchemyのDeclarativeBaseを継承

### 5.2 モデルクラス
1. User: ユーザー情報管理
   - 基本属性（ID、ユーザーID、名前、パスワード）
   - 状態フラグ（管理者、ロック、可視性）
   - ログイン試行関連（試行回数、最終試行日時）
   - パスワード検証機能
   - ロック状態チェック機能
   - Entriesとの1対多リレーション

2. Entry: 日記エントリー管理
   - 基本属性（ID、ユーザーID、タイトル、本文、メモ）
   - タイムスタンプ（作成日時、更新日時）
   - 更新機能
   - UserとDiaryItemsとのリレーション
   - カスケード削除設定

3. DiaryItem: 日記項目管理
   - 基本属性（ID、エントリーID、項目名、項目内容）
   - タイムスタンプ（作成日時）
   - Entryとのリレーション
   - カスケード削除設定

4. UserManager: ユーザー管理機能
   - ユーザー一覧取得（可視ユーザー/全ユーザー）
   - アカウントロック管理
   - 管理者権限管理

### 5.3 モジュール構成
```
models/
├── __init__.py    # モデルパッケージ初期化
├── base.py        # 基本クラス定義
├── user.py        # ユーザーモデル
├── entry.py       # 日記エントリーモデル
├── diary_item.py  # 日記項目モデル
├── user_manager.py # ユーザー管理機能
└── init_data.py   # 初期データ作成

models.py          # SQLAlchemyモデル定義（統合版）
```

## 6. セキュリティ仕様

### 6.1 認証と認可
1. セッション管理
   - Flaskセッションベースの認証
   - 本番環境用のセッションシークレットキーが必要
   - セッションデータの内容：
     - user_id: ユーザー識別子
     - is_admin: 管理者権限状態
     - name: 表示名
     - userid: ユーザーID

2. パスワードセキュリティ
   - パスワード要件：
     - 長さ：8-20文字
     - 必須文字：大文字、小文字、数字を各1文字以上
   - 本番環境ではパスワードハッシュ化が必要
   - パスワード変更時は現在のパスワード確認が必要

3. アクセス制御
   - ロールベースのアクセス制御（RBAC）：
     - 管理者
     - 一般ユーザー
     - 未ログインユーザー
   - デコレータによる機能レベルのアクセス制御：
     - @login_required
     - @admin_required

### 6.2 アカウントセキュリティ
1. ログイン保護
   - 最大3回のログイン試行
   - 3回失敗後の自動アカウントロック
   - ログイン試行の追跡：
     - 試行回数カウンター
     - 最終試行タイムスタンプ
   - ロック解除は管理者のみ可能

2. アカウント管理
   - 退会にはパスワード確認が必要
   - 管理者アカウントは退会不可
   - 退会済みアカウント：
     - ログイン不可
     - コンテンツは管理者のみ閲覧可能
   - アカウントの可視性は管理者が制御

### 6.3 データセキュリティ
1. データアクセス制御
   - 一般ユーザー：
     - アクティブユーザーの投稿のみ閲覧可能
     - 自身の投稿のみ編集・削除可能
   - 管理者：
     - すべての投稿にアクセス可能
     - すべての投稿を編集・削除可能
     - ユーザーアカウントの管理が可能

2. データベースセキュリティ
   - SQLAlchemyによるSQLインジェクション対策
   - 関連データの連鎖削除ルール
   - 外部キー制約
   - ユーザーIDの一意性制約

### 6.4 Webセキュリティ
1. CSRF対策
   - セッションベースのCSRF保護
   - すべてのPOST/PUT/DELETEリクエストで必須

2. セキュリティヘッダー（本番環境で必須）
   - X-Content-Type-Options
   - X-Frame-Options
   - X-XSS-Protection
   - Content-Security-Policy
   - Strict-Transport-Security

3. エラーハンドリング
   - ユーザーへの一般的なエラーメッセージ表示
   - デバッグ用の詳細ログ記録
   - エラーレスポンスに機密情報を含まない

### 6.5 本番環境要件
1. 環境セキュリティ
   - セキュアなセッションキーの設定
   - HTTPS実装
   - プロダクション用WSGIサーバー
   - 定期的なセキュリティアップデート

2. モニタリングとロギング
   - ログイン試行の監視
   - 管理者操作のログ記録
   - セキュリティイベントの追跡
   - 定期的なセキュリティ監査

## 7. テスト仕様

### 7.1 テスト構成
- pytest.iniによるテスト設定
  - テストパス: tests/
  - テストファイル命名規則: test_*.py
  - カバレッジレポート設定
- conftest.pyによるテストフィクスチャ定義
  - Flaskアプリケーション設定
  - データベース設定
  - セッション管理
- 個別のテストモジュール
  - test_user.py: ユーザー関連機能のテスト（カバレッジ100%）
  - test_entry.py: 日記エントリー関連機能のテスト（カバレッジ96%）
  - test_user_manager.py: ユーザー管理機能のテスト（カバレッジ100%）

### 7.2 テスト範囲
- ユーザー認証・登録機能
  - ユーザー作成
  - パスワード検証
  - ロック機能
- 日記の作成・編集・削除機能
  - エントリー作成
  - バリデーション
  - 更新処理
- ユーザー管理機能
  - ユーザー可視性制御
  - 管理者権限操作
  - ロック操作

### 7.3 テスト環境
- requirements-test.txtによるテスト用依存パッケージ管理
  - pytest 7.4.0
  - pytest-cov 4.1.0
  - coverage 7.3.0
- テスト用データベース
  - SQLite（インメモリ）
  - 自動作成・削除
- テストフィクスチャ
  - セッション管理
  - トランザクション制御
  - ロールバック機能

### 7.4 テストカバレッジ
- モデル層: 90%以上
  - User: 92%
  - Entry: 96%
  - DiaryItem: 93%
  - UserManager: 73%
- 改善が必要な領域
  - アプリケーション層（app.py）
  - データベース操作（database.py）
  - 初期データ作成（init_data.py）

## 8. 注意事項

### 8.1 開発環境での利用について
- このアプリケーションは開発環境用です
- 本番環境での使用には以下の対応が必要です：
  - セキュアなセッションキーの設定
  - プロダクション用WSGIサーバーの使用
  - パスワードのハッシュ化
  - データベースのバックアップ体制
  - エラーハンドリングの強化

### 8.2 制限事項
- ファイルのアップロード機能なし
- ページネーション機能なし
- パスワードリセット機能なし
- 退会処理の取り消し機能なし

### 8.3 開発環境要件
- Python 3.11.10
- Conda環境管理
- 必要なパッケージは`requirements.txt`に記載
- テスト用パッケージは`requirements-test.txt`に記載
