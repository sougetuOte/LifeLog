# LifeLog仕様書

## 更新履歴
- 2024/12/01: 0.01公開
- 2024/12/08: モデル構造の改善とテスト仕様の追加
- 2024/12/09: データベース構造とマイグレーション仕様の追加
- 2024/12/10: テストカバレッジの更新とセキュリティ仕様の詳細化、環境構築方法の変更


## 目次
1. [ユーザー管理機能](#1-ユーザー管理機能)
2. [日記管理機能](#2-日記管理機能)
3. [画面仕様](#3-画面仕様)
4. [データベース設計](#4-データベース設計)
5. [モデル構造](#5-モデル構造)
6. [セキュリティ仕様](#6-セキュリティ仕様)
7. [テスト仕様](#7-テスト仕様)
8. [注意事項](#8-注意事項)

## 1. ユーザー管理機能

### 1.1 ユーザー登録
- ユーザーID：4-20文字の半角英数字
- 名前（表示名）：3-20文字（文字種自由）
- パスワード：8-20文字（大文字・小文字・数字を各1文字以上含む）

### 1.2 ログイン機能
- ユーザーIDとパスワードによる認証
- 3回連続ログイン失敗でアカウントロック
- ロック解除は管理者のみ可能
- 退会済みユーザーはログイン不可（「ユーザーIDまたはパスワードが正しくありません」と表示）
 
### 1.3 退会機能
- パスワード確認による本人確認
- 退会後のアカウントは以下の制限が適用：
  - ログイン不可
  - 投稿した日記は管理者のみ閲覧可能
- 管理者アカウントは退会不可
- 退会処理は取り消し不可

### 1.4 ユーザー権限
1. 管理者（admin）
   - 全ユーザーの日記の閲覧・編集・削除（退会済みユーザーの日記を含む）
   - ユーザー管理（ロック解除、管理者権限の付与/削除）
   - 退会済みユーザーの日記の管理
   - 自身の設定変更（退会不可）

2. 一般ユーザー
   - アクティブなユーザーの日記の閲覧
   - 自身の日記の投稿・編集・削除
   - 自身の設定変更（退会可能）

3. 未ログインユーザー
   - アクティブなユーザーの日記の閲覧のみ

## 2. 日記管理機能

### 2.1 日記投稿
- タイトル（必須）
- 本文（必須）
- メモ（任意、天気・気分・体調など）
- 作成日時の自動記録
- 更新日時の自動記録（編集時）

### 2.2 日記表示
- 新しい順に表示
- 投稿者名とユーザーIDを表示
- 作成日時と最終更新日時を表示
- 編集・削除ボタンは権限のあるユーザーにのみ表示
- 退会済みユーザーの日記は管理者のみ閲覧可能

### 2.3 ユーザー設定機能

#### 2.3.1 設定可能項目
- 表示名の変更
- パスワードの変更（現在のパスワード確認あり）
- アカウント退会（パスワード確認あり）

### 2.4 管理者機能

#### 2.4.1 ユーザー管理
- ユーザー一覧の表示
  - アクティブユーザー
  - 退会済みユーザー（半透明表示）
- アカウントのロック状態の確認と解除
- 管理者権限の付与/削除（アクティブユーザーのみ）
- ログイン試行履歴の確認
- 退会済みユーザーの日記管理

## 3. 画面仕様

### 3.1 共通ヘッダー
未ログイン時：
- ホーム
- ログイン
- 新規登録

ログイン時：
- ホーム
- ユーザー設定
- ユーザー管理（管理者のみ）
- ログアウト
- ユーザー名表示
- 管理者バッジ（管理者のみ）

### 3.2 各画面

#### 3.2.1 ホーム画面（/）
- 日記一覧表示
- 投稿フォーム（ログイン時のみ）
  - タイトル入力
  - 本文入力
  - メモ入力（天気、気分、体調など）
- ページネーションなし

#### 3.2.2 ログイン画面（/login）
- ユーザーID入力
- パスワード入力
- ログイン試行回数表示
- エラーメッセージ表示

#### 3.2.3 ユーザー登録画面（/register）
- ユーザーID入力（バリデーション付き）
- 名前入力（バリデーション付き）
- パスワード入力（バリデーション付き）
- 入力規則の表示
- エラーメッセージ表示

#### 3.2.4 ユーザー設定画面（/settings）
- 表示名変更
- パスワード変更
- 現在の設定表示
- アカウント退会セクション
  - 退会ボタン
  - 確認モーダル
  - パスワード確認

#### 3.2.5 管理者画面（/admin）
- ユーザー一覧
  - アクティブ/退会済み状態表示
  - ロック状態表示
  - ログイン試行履歴
  - 管理者権限操作ボタン（アクティブユーザーのみ）
  - ロック解除ボタン

## 4. データベース設計

### 4.1 usersテーブル
```sql
CREATE TABLE users (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    userid TEXT NOT NULL UNIQUE,
    name TEXT NOT NULL,
    password TEXT NOT NULL,
    is_admin BOOLEAN NOT NULL DEFAULT 0,
    is_locked BOOLEAN NOT NULL DEFAULT 0,
    is_visible BOOLEAN NOT NULL DEFAULT 1,
    login_attempts INTEGER NOT NULL DEFAULT 0,
    last_login_attempt DATETIME,
    created_at DATETIME NOT NULL
);
```

### 4.2 entriesテーブル
```sql
CREATE TABLE entries (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id INTEGER NOT NULL,
    title TEXT NOT NULL,
    content TEXT NOT NULL,
    notes TEXT NOT NULL DEFAULT '',
    created_at DATETIME NOT NULL,
    updated_at DATETIME,
    FOREIGN KEY (user_id) REFERENCES users (id) ON DELETE CASCADE
);
```

### 4.3 diary_itemsテーブル
```sql
CREATE TABLE diary_items (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    entry_id INTEGER NOT NULL,
    item_name TEXT NOT NULL,
    item_content TEXT NOT NULL,
    created_at DATETIME NOT NULL,
    FOREIGN KEY (entry_id) REFERENCES entries (id) ON DELETE CASCADE
);
```

### 4.4 マイグレーション管理
- Alembicを使用したマイグレーション管理
- マイグレーションファイルは`migrations/versions/`に保存
- マイグレーション設定は`alembic.ini`で管理

## 5. モデル構造

### 5.1 基本構造
- Base: すべてのモデルの基底クラス
  - SQLAlchemyのDeclarativeBaseを継承

### 5.2 モデルクラス
1. User: ユーザー情報管理
   - 基本属性（ID、ユーザーID、名前、パスワード）
   - 状態フラグ（管理者、ロック、可視性）
   - ログイン試行関連（試行回数、最終試行日時）
   - パスワード検証機能
   - ロック状態チェック機能
   - Entriesとの1対多リレーション

2. Entry: 日記エントリー管理
   - 基本属性（ID、ユーザーID、タイトル、本文、メモ）
   - タイムスタンプ（作成日時、更新日時）
   - 更新機能
   - UserとDiaryItemsとのリレーション
   - カスケード削除設定

3. DiaryItem: 日記項目管理
   - 基本属性（ID、エントリーID、項目名、項目内容）
   - タイムスタンプ（作成日時）
   - Entryとのリレーション
   - カスケード削除設定

4. UserManager: ユーザー管理機能
   - ユーザー一覧取得（可視ユーザー/全ユーザー）
   - アカウントロック管理
   - 管理者権限管理

### 5.3 モジュール構成
```
models/
├── __init__.py    # モデルパッケージ初期化
├── base.py        # 基本クラス定義
├── user.py        # ユーザーモデル
├── entry.py       # 日記エントリーモデル
├── diary_item.py  # 日記項目モデル
├── user_manager.py # ユーザー管理機能
└── init_data.py   # 初期データ作成

models.py          # SQLAlchemyモデル定義（統合版）
```

## 6. セキュリティ仕様

### 6.1 アカウントセキュリティ

#### 6.1.1 パスワードポリシー
- 長さ：8-20文字
- 必須文字種：
  - 大文字アルファベット（A-Z）を1文字以上
  - 小文字アルファベット（a-z）を1文字以上
  - 数字（0-9）を1文字以上
- 禁止文字：
  - 空白
  - タブ
  - 改行
  - 特殊文字（< > & ' "）
- パスワード履歴：過去3世代のパスワードは再利用不可
- パスワード有効期限：90日

#### 6.1.2 アカウントロック機能
- ロック条件：3回連続ログイン失敗
- ロック期間：24時間（管理者による手動解除も可能）
- ロック解除条件：
  - 管理者による手動解除
  - ロック期間経過後の管理者承認
- ロック中の制限：
  - ログイン試行不可
  - パスワードリセット不可

#### 6.1.3 セッション管理
- セッション有効期限：30分
- 同時セッション：1ユーザーにつき1セッションのみ許可
- セッション無効化条件：
  - ログアウト
  - タイムアウト
  - パスワード変更
  - アカウントロック
  - 管理者による強制ログアウト

### 6.2 アクセス制御

#### 6.2.1 認証方式
- フォームベース認証
- セッションベースの状態管理
- Remember-Me機能なし
- 自動ログアウト（30分）

#### 6.2.2 権限管理
- ロールベースアクセス制御（RBAC）
- 権限レベル：
  1. 管理者（全機能アクセス可）
  2. 一般ユーザー（制限付きアクセス）
  3. 未ログインユーザー（閲覧のみ）
- アクセス制御：
  - URL単位
  - 機能単位
  - データ単位

#### 6.2.3 CSRF対策
- Flaskの組み込みCSRF対策機能を使用
- すべてのPOST/PUT/DELETEリクエストにCSRFトークンを要求
- トークンの有効期限：セッションと同期
- Double Submit Cookie対策

### 6.3 データ保護

#### 6.3.1 パスワード保護
- ハッシュアルゴリズム：Argon2id
- ソルト：ユーザーごとにランダム生成（16バイト）
- ストレッチング：10,000回
- メモリコスト：64MB

#### 6.3.2 データベースセキュリティ
- プリペアドステートメントの使用
- SQLインジェクション対策
- バックアップ：
  - 日次完全バックアップ
  - 1時間ごとの差分バックアップ
  - 暗号化バックアップ

#### 6.3.3 機密データの保護
- 個人情報の暗号化（AES-256-GCM）
- 監査ログの保存：
  - ログイン試行
  - 重要な操作
  - エラー
  - セキュリティイベント

### 6.4 通信セキュリティ

#### 6.4.1 HTTPS
- TLS 1.3のみ使用
- 強力な暗号スイートの使用
- HSTS（HTTP Strict Transport Security）の有効化
- 証明書のピン留め

#### 6.4.2 セキュリティヘッダー
- Content-Security-Policy (CSP)
- X-Frame-Options
- X-Content-Type-Options
- X-XSS-Protection
- Referrer-Policy
- Feature-Policy

#### 6.4.3 APIセキュリティ
- レート制限：
  - IP単位：100リクエスト/分
  - ユーザー単位：50リクエスト/分
- リクエストサイズ制限：10MB
- タイムアウト：30秒

### 6.5 監視とログ

#### 6.5.1 セキュリティ監視
- リアルタイムアラート：
  - 連続ログイン失敗
  - 異常なアクセスパターン
  - 権限昇格の試行
- 定期的なセキュリティスキャン
- 脆弱性評価

#### 6.5.2 ログ管理
- アクセスログ
- セキュリティイベントログ
- エラーログ
- 監査ログ
- ログの保存期間：1年
- ログの暗号化



## 7. テスト仕様

### 7.1 テスト構成
- pytest.iniによるテスト設定
  - テストパス: tests/
  - テストファイル命名規則: test_*.py
  - カバレッジレポート設定
  - 最小カバレッジ要件: 90%
- conftest.pyによるテストフィクスチャ定義
  - Flaskアプリケーション設定
  - データベース設定（インメモリSQLite）
  - セッション管理
  - トランザクション制御
- 個別のテストモジュール
  - test_user.py: ユーザー関連機能のテスト（カバレッジ92%）
  - test_entry.py: 日記エントリー関連機能のテスト（カバレッジ96%）
  - test_user_manager.py: ユーザー管理機能のテスト（カバレッジ90%）

### 7.2 テスト範囲

#### 7.2.1 ユーザー認証・登録機能
- ユーザー作成
  - 正常系: 有効なデータでの作成
  - 異常系: 無効なデータでの作成試行
- パスワード検証
  - 正常系: 正しいパスワード
  - 異常系: 誤ったパスワード
- ロック機能
  - ログイン試行回数の管理
  - アカウントロックの発生
  - ロック解除処理

#### 7.2.2 日記の作成・編集・削除機能
- エントリー作成
  - 必須項目の検証
  - 文字数制限の検証
- バリデーション
  - タイトルと本文の必須チェック
  - メモの任意入力
- 更新処理
  - 作成日時の自動設定
  - 更新日時の自動更新
- 削除処理
  - カスケード削除の確認
  - 関連データの整合性

#### 7.2.3 ユーザー管理機能
- ユーザー可視性制御
  - アクティブユーザーの表示
  - 退会済みユーザーの非表示
- 管理者権限操作
  - 権限付与のテスト
  - 権限削除のテスト
- ロック操作
  - ロック状態の変更
  - ロック解除の権限確認

### 7.3 テスト環境
- requirements-test.txtによるテスト用依存パッケージ管理
  - pytest 8.3.4
  - pytest-cov 6.0.0
  - coverage 7.6.9
- テスト用データベース
  - SQLite（インメモリ）
  - 自動作成・削除
  - トランザクション制御
- テストフィクスチャ
  - セッション管理
  - データベース初期化
  - ユーザーデータ生成
  - 日記データ生成

### 7.4 テストカバレッジ
- モデル層: 92%以上
  - User: 92%
  - Entry: 96%
  - DiaryItem: 93%
  - UserManager: 90%
- アプリケーション層: 85%
  - app.py: 87%
  - database.py: 85%
  - init_data.py: 83%
- 改善計画
  - アプリケーション層のカバレッジ向上
  - エラーハンドリングのテスト強化
  - 境界値テストの追加

### 7.5 開発環境
- Python 3.11（conda環境）
- 主要パッケージ
  - Flask 3.1.0
  - SQLAlchemy 2.0.36
  - Flask-SQLAlchemy 3.1.1
  - Alembic 1.14.0
  - Flask-WTF 1.2.1
  - WTForms 3.1.2
  - pyppeteer 2.0.0
  - pyyaml 6.0.2

## 8. 注意事項

### 8.1 開発環境での利用について
- このアプリケーションは開発環境用です
- 本番環境での使用には以下の対応が必要です：
  - セキュアなセッションキーの設定
  - プロダクション用WSGIサーバーの使用
  - パスワードのハッシュ化
  - データベースのバックアップ体制
  - エラーハンドリングの強化
  - ログ出力の設定
  - パフォーマンスチューニング

### 8.2 制限事項
- ファイルのアップロード機能なし
- ページネーション機能なし
- パスワードリセット機能なし
- 退会処理の取り消し機能なし
- 一括操作機能なし
- APIドキュメント未整備

