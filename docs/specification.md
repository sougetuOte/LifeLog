# LifeLog仕様書

## 目次
1. [ユーザー管理機能](#1-ユーザー管理機能)
2. [日記管理機能](#2-日記管理機能)
3. [画面仕様](#3-画面仕様)
4. [データベース設計](#4-データベース設計)
5. [セキュリティ仕様](#5-セキュリティ仕様)

## 1. ユーザー管理機能

### 1.1 ユーザー登録
- ユーザーID：4-20文字の半角英数字
- 名前（表示名）：3-20文字（文字種自由）
- パスワード：8-20文字（大文字・小文字・数字を各1文字以上含む）

### 1.2 ログイン機能
- ユーザーIDとパスワードによる認証
- 3回連続ログイン失敗でアカウントロック
- ロック解除は管理者のみ可能
- 退会済みユーザーはログイン不可（「ユーザーIDまたはパスワードが正しくありません」と表示）
 
### 1.3 退会機能
- パスワード確認による本人確認
- 退会後のアカウントは以下の制限が適用：
  - ログイン不可
  - 投稿した日記は管理者のみ閲覧可能
- 管理者アカウントは退会不可
- 退会処理は取り消し不可

### 1.4 ユーザー権限
1. 管理者（admin）
   - 全ユーザーの日記の閲覧・編集・削除（退会済みユーザーの日記を含む）
   - ユーザー管理（ロック解除、管理者権限の付与/削除）
   - 退会済みユーザーの日記の管理
   - 自身の設定変更（退会不可）

2. 一般ユーザー
   - アクティブなユーザーの日記の閲覧
   - 自身の日記の投稿・編集・削除
   - 自身の設定変更（退会可能）

3. 未ログインユーザー
   - アクティブなユーザーの日記の閲覧のみ

### 2.2 日記管理機能

#### 2.2.1 日記投稿
- タイトル（必須）
- 本文（必須）
- メモ（任意、天気・気分・体調など）
- 作成日時の自動記録
- 更新日時の自動記録（編集時）


#### 2.2.2 日記表示
- 新しい順に表示
- 投稿者名とユーザーIDを表示
- 作成日時と最終更新日時を表示
- 編集・削除ボタンは権限のあるユーザーにのみ表示
- 退会済みユーザーの日記は管理者のみ閲覧可能

### 2.3 ユーザー設定機能

#### 2.3.1 設定可能項目
- 表示名の変更
- パスワードの変更（現在のパスワード確認あり）
- アカウント退会（パスワード確認あり）

### 2.4 管理者機能

#### 2.4.1 ユーザー管理
- ユーザー一覧の表示
  - アクティブユーザー
  - 退会済みユーザー（半透明表示）
- アカウントのロック状態の確認と解除
- 管理者権限の付与/削除（アクティブユーザーのみ）
- ログイン試行履歴の確認
- 退会済みユーザーの日記管理

## 3. 画面仕様

### 3.1 共通ヘッダー
未ログイン時：
- ホーム
- ログイン
- 新規登録

ログイン時：
- ホーム
- ユーザー設定
- ユーザー管理（管理者のみ）
- ログアウト
- ユーザー名表示
- 管理者バッジ（管理者のみ）

### 3.2 各画面

#### 3.2.1 ホーム画面（/）
- 日記一覧表示
- 投稿フォーム（ログイン時のみ）
  - タイトル入力
  - 本文入力
  - メモ入力（天気、気分、体調など）
- ページネーションなし

#### 3.2.2 ログイン画面（/login）
- ユーザーID入力
- パスワード入力
- ログイン試行回数表示
- エラーメッセージ表示

#### 3.2.3 ユーザー登録画面（/register）
- ユーザーID入力（バリデーション付き）
- 名前入力（バリデーション付き）
- パスワード入力（バリデーション付き）
- 入力規則の表示
- エラーメッセージ表示

#### 3.2.4 ユーザー設定画面（/settings）
- 表示名変更
- パスワード変更
- 現在の設定表示
- アカウント退会セクション
  - 退会ボタン
  - 確認モーダル
  - パスワード確認

#### 3.2.5 管理者画面（/admin）
- ユーザー一覧
  - アクティブ/退会済み状態表示
  - ロック状態表示
  - ログイン試行履歴
  - 管理者権限操作ボタン（アクティブユーザーのみ）
  - ロック解除ボタン

## 4. データベース設計

### 4.1 usersテーブル
```sql
CREATE TABLE users (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    userid TEXT NOT NULL UNIQUE,
    name TEXT NOT NULL,
    password TEXT NOT NULL,
    is_admin BOOLEAN NOT NULL DEFAULT 0,
    is_locked BOOLEAN NOT NULL DEFAULT 0,
    is_visible BOOLEAN NOT NULL DEFAULT 1,
    login_attempts INTEGER NOT NULL DEFAULT 0,
    last_login_attempt TEXT,
    created_at TEXT NOT NULL
);
```

### 4.2 entriesテーブル
```sql
CREATE TABLE entries (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id INTEGER NOT NULL,
    title TEXT NOT NULL,
    content TEXT NOT NULL,
    notes TEXT NOT NULL DEFAULT '',
    created_at TEXT NOT NULL,
    updated_at TEXT,
    FOREIGN KEY (user_id) REFERENCES users (id)
);
```

## 5. セキュリティ仕様

### 5.1 アカウントセキュリティ
- パスワードの複雑性要件
- ログイン試行回数制限
- アカウントロック機能
- 退会時のパスワード確認

### 5.2 アクセス制御
- セッションベースの認証
- 権限に基づくアクセス制御
- CSRF対策（Flaskの組み込み機能）
- 退会済みユーザーの日記は管理者のみアクセス可能

## 6. 注意事項

### 6.1 開発環境での利用について
- このアプリケーションは開発環境用です
- 本番環境での使用には以下の対応が必要です：
  - セキュアなセッションキーの設定
  - プロダクション用WSGIサーバーの使用
  - パスワードのハッシュ化
  - データベースのバックアップ体制
  - エラーハンドリングの強化

### 6.2 制限事項
- ファイルのアップロード機能なし
- ページネーション機能なし
- パスワードリセット機能なし
- 退会処理の取り消し機能なし


