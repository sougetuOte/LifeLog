<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç† - LifeLog</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='main.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='admin.css') }}">
    <style>
        .deactivated {
            opacity: 0.7;
            background-color: #f8f8f8;
        }
        .deactivated-badge {
            background-color: #666;
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.8em;
            margin-left: 8px;
        }
        .user-status-badges {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            align-items: center;
        }
        .visibility-info {
            font-size: 0.9em;
            color: #666;
            margin-top: 4px;
        }
        .entries-count {
            font-size: 0.9em;
            color: #2196F3;
            margin-top: 4px;
        }
        .delete-btn {
            background-color: #ff4444;
        }
        .restore-btn {
            background-color: #4CAF50;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>LifeLog</h1>
            <nav class="nav-menu">
                <a href="/" class="nav-link">ãƒ›ãƒ¼ãƒ </a>
                <a href="/settings" class="nav-link">ãƒ¦ãƒ¼ã‚¶ãƒ¼è¨­å®š</a>
                <span class="user-info">
                    {{ session.name }}
                    <span class="admin-badge">ç®¡ç†è€…</span>
                </span>
                <button onclick="logout()" class="logout-btn">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
            </nav>
        </div>

        <div class="admin-panel">
            <h2>ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†</h2>
            <div id="error-message" class="error-message" style="display: none;"></div>
            <div id="success-message" class="success-message" style="display: none;"></div>

            <div id="users-list" class="users-list">
                <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ãŒJavaScriptã§è¿½åŠ ã•ã‚Œã¾ã™ -->
            </div>
        </div>
    </div>

    <script>
        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ã‚’èª­ã¿è¾¼ã¿
        async function loadUsers() {
            try {
                const response = await fetch('/api/admin/users');
                const users = await response.json();
                
                const usersList = document.getElementById('users-list');
                usersList.innerHTML = users.map(user => `
                    <div class="user-item ${user.is_locked ? 'locked' : ''} ${!user.is_visible ? 'deactivated' : ''}">
                        <div class="user-info-admin">
                            <div class="user-primary-info">
                                <span class="user-name">${escapeHtml(user.name)}</span>
                                <span class="user-id">@${escapeHtml(user.userid)}</span>
                                <div class="user-status-badges">
                                    ${user.is_admin ? '<span class="admin-badge">ç®¡ç†è€…</span>' : ''}
                                    ${user.is_locked ? '<span class="locked-badge">ãƒ­ãƒƒã‚¯ä¸­</span>' : ''}
                                    ${!user.is_visible ? '<span class="deactivated-badge">é€€ä¼šæ¸ˆã¿</span>' : ''}
                                </div>
                            </div>
                            <div class="user-secondary-info">
                                <div class="login-info">
                                    ãƒ­ã‚°ã‚¤ãƒ³è©¦è¡Œ: ${user.login_attempts}å›
                                    ${user.last_login_attempt ? `/ æœ€çµ‚è©¦è¡Œ: ${new Date(user.last_login_attempt).toLocaleString('ja-JP')}` : ''}
                                </div>
                                <div class="entries-count">
                                    æŠ•ç¨¿æ•°: ${user.entries_count}ä»¶
                                </div>
                                ${!user.is_visible ? `
                                    <div class="visibility-info">
                                        â€»ã“ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ—¥è¨˜ã¯ç®¡ç†è€…ã®ã¿é–²è¦§å¯èƒ½ã§ã™
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                        <div class="user-actions">
                            ${user.is_locked && user.is_visible ? `
                                <button onclick="unlockUser(${user.id})" class="unlock-btn">
                                    <span class="unlock-icon">ğŸ”“</span>
                                    ãƒ­ãƒƒã‚¯è§£é™¤
                                </button>
                            ` : ''}
                            ${!user.is_admin ? `
                                <button onclick="toggleVisibility(${user.id})" class="${user.is_visible ? 'delete-btn' : 'restore-btn'}">
                                    ${user.is_visible ? 'ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å‰Šé™¤' : 'ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å¾©å…ƒ'}
                                </button>
                            ` : ''}
                            ${user.is_visible && !user.is_admin ? `
                                <button onclick="toggleAdmin(${user.id})" class="toggle-admin-btn">
                                    ${user.is_admin ? 'ç®¡ç†è€…æ¨©é™ã‚’å‰Šé™¤' : 'ç®¡ç†è€…æ¨©é™ã‚’ä»˜ä¸'}
                                </button>
                            ` : ''}
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error:', error);
                showError('ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        }

        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ­ãƒƒã‚¯ã‚’è§£é™¤
        async function unlockUser(userId) {
            if (!confirm('ã“ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ­ãƒƒã‚¯ã‚’è§£é™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                return;
            }

            try {
                const response = await fetch(`/api/admin/users/${userId}/unlock`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                const data = await response.json();
                
                if (response.ok) {
                    showSuccess(data.message);
                    loadUsers();
                } else {
                    showError(data.error || 'ãƒ­ãƒƒã‚¯è§£é™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
            } catch (error) {
                console.error('Error:', error);
                showError('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
            }
        }

        // ç®¡ç†è€…æ¨©é™ã®åˆ‡ã‚Šæ›¿ãˆ
        async function toggleAdmin(userId) {
            if (!confirm('ã“ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ç®¡ç†è€…æ¨©é™ã‚’å¤‰æ›´ã—ã¾ã™ã‹ï¼Ÿ')) {
                return;
            }

            try {
                const response = await fetch(`/api/admin/users/${userId}/toggle-admin`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                const data = await response.json();
                
                if (response.ok) {
                    showSuccess(data.message);
                    loadUsers();
                } else {
                    showError(data.error || 'æ¨©é™ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
            } catch (error) {
                console.error('Error:', error);
                showError('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
            }
        }

        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å¯è¦–æ€§ã‚’åˆ‡ã‚Šæ›¿ãˆ
        async function toggleVisibility(userId) {
            if (!confirm('ã“ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®çŠ¶æ…‹ã‚’å¤‰æ›´ã—ã¾ã™ã‹ï¼Ÿ')) {
                return;
            }

            try {
                const response = await fetch(`/api/admin/users/${userId}/toggle-visibility`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                const data = await response.json();
                
                if (response.ok) {
                    showSuccess(data.message);
                    loadUsers();
                } else {
                    showError(data.error || 'ãƒ¦ãƒ¼ã‚¶ãƒ¼çŠ¶æ…‹ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
            } catch (error) {
                console.error('Error:', error);
                showError('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
            }
        }

        function showError(message) {
            const errorMessage = document.getElementById('error-message');
            const successMessage = document.getElementById('success-message');
            errorMessage.textContent = message;
            errorMessage.style.display = 'block';
            successMessage.style.display = 'none';
            
            setTimeout(() => {
                errorMessage.style.display = 'none';
            }, 5000);
        }

        function showSuccess(message) {
            const errorMessage = document.getElementById('error-message');
            const successMessage = document.getElementById('success-message');
            successMessage.textContent = message;
            successMessage.style.display = 'block';
            errorMessage.style.display = 'none';
            
            setTimeout(() => {
                successMessage.style.display = 'none';
            }, 5000);
        }

        function escapeHtml(unsafe) {
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        async function logout() {
            try {
                const response = await fetch('/api/logout', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                if (response.ok) {
                    window.location.href = '/login';
                } else {
                    showError('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
            } catch (error) {
                console.error('Error:', error);
                showError('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
            }
        }

        // åˆæœŸãƒ­ãƒ¼ãƒ‰
        loadUsers();

        // å®šæœŸçš„ãªæ›´æ–°ï¼ˆ30ç§’ã”ã¨ï¼‰
        setInterval(loadUsers, 30000);
    </script>
</body>
</html>
